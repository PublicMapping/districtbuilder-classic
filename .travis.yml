language: python
services:
- docker
env:
  global:
  - AWS_DEFAULT_REGION=us-east-1
  - secure: W3UWMkZlhIJhnRd7Lulye7f6CfuYMErTe+8K3ekRD25DFE3d4vUXJMeO1G9flkiAEojzG1aqKeO3JLL5c7E+kq9SnojttUBEhlkJYhcSwVAMqxsxcbUzRCsRh+et/y49rVHE52SDYBedC0U2UUnrorJoofeSH/IY4w8j5XJXgQeEO1wGm5wEuxfOxMCecvHb5ZVpxDYrQhVCYk1TPU8IglDn4ybYIzekcPWxnZYZCZLsueFRYSx3esJRVThHDSA1jPX/dsMOpaX1/XbWSeZZ1l+95p6lUgzVtUl4qf4IB08qZyDfs8R3ilu+mdcT5fdoSHZKc7fgveNr6k3aZys8E/uf/1FU0eLOF7vJO8Q1h2S+yRZhM29fHc8C5HJewsGt6EP3sufjg7JKkydXZ2Iy6DVLmQ+4q0ucYWqT4dqufSA06HqIa0v5NPwHeheOfbUXDH73y1rtvy4KfGQHwn1kHYlspg3XLmhO7n65oDc2YwRAMdJ93JUde5ruiIDr/6UwPwc837F+7TeluQO3NIu0e5L6syRH4HQM6nOa14JrUmsZYP2BjmFY9aphuNmGpk6Du5q2xtOnKl+4cQFAXPaL4Ape57R2nnm304g6XLsAr6Y/D7gHeTjdpRofx2mC+6+8nUykBpljGgvbm2fxBCJHEYrvv47owcF6pRdrXG//yq4=
  - secure: nI9KxVxRkMYB779SOTtpHn6AeP+GY1fEQlgTs33eyK2wKVME1+jbn6C5pahoVPxI2RUGRf0lw8rjQLBWPkL95me1wHn1nTbVYNsbaenQMyPWANFUg4cFxAnWWpoz1bH37PGC++ahehH7/ebhxgpYNBWLAvmMvJLGCRBDJED515GcnfIL7fW9z5tun0hBUflCZkJh1Iva6SQCGIm6yJwFzUSkHkddE59hlIx2XABSNg8fKzCH0GThHZkKfMDfh+ZLAJuJ26Nvjnkcpy1yfQbc0NJBa0erV3b7GnpB4ewc98Vj/8+iFwloJUhLgRjjVMAZ9M0YMWro6LpazQbXyy4NUkVkZnJuaEGkKZqGU3yYeRSlcZVQyVQGd0LwWV4sqYQ01Yq/YIIyN8EGb4msAwezgzKprZD7yvpRxy/Xgi9TP12aRLPQSeE2YyDeH4RPFGHx2qSYyMbRkdQeRR9LmY3AtlLJhOebwQC35jHz1jNwKkFk4HNb6fgW0p2BsSDUUMEpVwkwuuFcZZTaxKibZ5HIOozKEkXSVOBFIlnRXYFY2QuKrE459PojHU4Jh1bx6RxgSP9TiovF8CM670veZNvzCW2US4258cbFWWJzsaTsxOA0KNqdQXjQJitvl3Z9xLxDoTe0lukj//sp1tybFzfgaLFQQuUw6HG7+W6AcyC7j54=
install:
- pip install awscli
- cp .env.sample .env
- sed -i 's/WEB_APP_PASSWORD=/WEB_APP_PASSWORD=travis/' .env
- sed -i 's/ADMIN_PASSWORD=/ADMIN_PASSWORD=admin/' .env
- sed -i 's/DATABASE_PASSWORD=/DATABASE_PASSWORD=district_builder/' .env
- sed -i 's/KEY_VALUE_STORE_PASSWORD=/KEY_VALUE_STORE_PASSWORD=redis/' .env
- sed -i 's/MAP_SERVER_ADMIN_PASSWORD=/MAP_SERVER_ADMIN_PASSWORD=geoserver/' .env
- "./scripts/update"
- wget -qO ./data/districtbuilder_data.zip http://s3.amazonaws.com/global-districtbuilder-data-us-east-1/pa/pa_3785_census.zip
script:
- "./scripts/test"
before_deploy:
- mkdir -p ~/.ssh
- openssl aes-256-cbc -K $encrypted_c49e2c465c08_key -iv $encrypted_c49e2c465c08_iv
  -in district-builder-pa.pem.enc -out ~/.ssh/district-builder-pa.pem -d
- cp django/publicmapping/config/config.xml deployment/user-data/config.xml
- mv ./data/districtbuilder_data.zip deployment/user-data/
deploy:
- provider: script
  skip_cleanup: true
  script: scripts/deploy
  on:
    repo: azavea/district-builder-dtl-pa
    branch: master
- provider: script
  skip_cleanup: true
  script: scripts/deploy
  on:
    repo: azavea/district-builder-dtl-pa
    branch: develop
after_deploy:
- git clean -fdx
- rm -f ~/.ssh/district-builder-pa.pem
