language: python
services:
- docker
env:
  global:
  - AWS_DEFAULT_REGION=us-east-1
  - secure: W3UWMkZlhIJhnRd7Lulye7f6CfuYMErTe+8K3ekRD25DFE3d4vUXJMeO1G9flkiAEojzG1aqKeO3JLL5c7E+kq9SnojttUBEhlkJYhcSwVAMqxsxcbUzRCsRh+et/y49rVHE52SDYBedC0U2UUnrorJoofeSH/IY4w8j5XJXgQeEO1wGm5wEuxfOxMCecvHb5ZVpxDYrQhVCYk1TPU8IglDn4ybYIzekcPWxnZYZCZLsueFRYSx3esJRVThHDSA1jPX/dsMOpaX1/XbWSeZZ1l+95p6lUgzVtUl4qf4IB08qZyDfs8R3ilu+mdcT5fdoSHZKc7fgveNr6k3aZys8E/uf/1FU0eLOF7vJO8Q1h2S+yRZhM29fHc8C5HJewsGt6EP3sufjg7JKkydXZ2Iy6DVLmQ+4q0ucYWqT4dqufSA06HqIa0v5NPwHeheOfbUXDH73y1rtvy4KfGQHwn1kHYlspg3XLmhO7n65oDc2YwRAMdJ93JUde5ruiIDr/6UwPwc837F+7TeluQO3NIu0e5L6syRH4HQM6nOa14JrUmsZYP2BjmFY9aphuNmGpk6Du5q2xtOnKl+4cQFAXPaL4Ape57R2nnm304g6XLsAr6Y/D7gHeTjdpRofx2mC+6+8nUykBpljGgvbm2fxBCJHEYrvv47owcF6pRdrXG//yq4=
  - secure: nI9KxVxRkMYB779SOTtpHn6AeP+GY1fEQlgTs33eyK2wKVME1+jbn6C5pahoVPxI2RUGRf0lw8rjQLBWPkL95me1wHn1nTbVYNsbaenQMyPWANFUg4cFxAnWWpoz1bH37PGC++ahehH7/ebhxgpYNBWLAvmMvJLGCRBDJED515GcnfIL7fW9z5tun0hBUflCZkJh1Iva6SQCGIm6yJwFzUSkHkddE59hlIx2XABSNg8fKzCH0GThHZkKfMDfh+ZLAJuJ26Nvjnkcpy1yfQbc0NJBa0erV3b7GnpB4ewc98Vj/8+iFwloJUhLgRjjVMAZ9M0YMWro6LpazQbXyy4NUkVkZnJuaEGkKZqGU3yYeRSlcZVQyVQGd0LwWV4sqYQ01Yq/YIIyN8EGb4msAwezgzKprZD7yvpRxy/Xgi9TP12aRLPQSeE2YyDeH4RPFGHx2qSYyMbRkdQeRR9LmY3AtlLJhOebwQC35jHz1jNwKkFk4HNb6fgW0p2BsSDUUMEpVwkwuuFcZZTaxKibZ5HIOozKEkXSVOBFIlnRXYFY2QuKrE459PojHU4Jh1bx6RxgSP9TiovF8CM670veZNvzCW2US4258cbFWWJzsaTsxOA0KNqdQXjQJitvl3Z9xLxDoTe0lukj//sp1tybFzfgaLFQQuUw6HG7+W6AcyC7j54=
  - secure: Usk91YDPVi6z27MRl1nWscG5rWIWs6g8/C3/tdd/2+g3AQUhPPOX0eNJuqYehRv1U7RNocUQnGXYzgIDmXTEx3uQY4qH8++jPn3AUeTClqKcQrI7gTTXqWHPhauzGokn2x0PU/WtumtRVG0RJGHG19Nb1J+An1ByOacYUTFJuVixMEUlHr7YDpibAKEkjm6+c45yrbfl1TxddmAayNSfmUWbfL+wJNgitv/PqR/gdiv2zHfUgdFoD+sXkojHHp8beqwhMMa8EEGh48/3tcr3TmEV17CSAYOoNi9pUG9TZKnQy0u7qG3leaMOKXdC2BnnTYBRQaAxUWDo3QF5IZeU+6Uobs7zxyvSzYqfrda2aqRMeCGUqkHZ8D0ZdI0Ezn3gKSZcdcuCs80ESyjf6ls2ekJBeFTxfdVjod7b6jhKzxzaikrM8u+4Esdn18ED8eXifRj/OrYHTVV8ysne+nlRBDDds1y07DvZE2qOicl8QOFw6fkAoWEbsVvOFku2sHUtFsOs8ategAcVZTW22g8aX1PmGX8d9nOhWGwIBBCMPMOItBSHb0+dD3HIABYKeGjYrSYV8Xw8OrmNPgg5VkOyLcTszALglvkPjVl5dRvMh86iVPasavYkcnO/wFsQz0vt4/aSGkWuZJ62hfRSwEN6lCF+c2y9Z/VJ5I47n3JoUn0=
  - secure: f3YY8IEacet+dShRufP5eA9fe2ulPKZ9mFdDMvqzeMz24K64lT8OIJ11qD4hNVlKL6wxq0uIaxwx6Q8mVDTqqm+SSMNbYvA2FrrwM4xO+S0bd70B0bRdWDUnVyY+dcchV8UnGbC9PoyBUcVi+bWaG+pZN6bG4jnGXB31ynTUJTb1bNh37LOAI2+DqjMGE4h4YYwP669CRl47FUKPJElx4jIOIZkJHxAyZ1LziAZuvsZ195LoV7Uj+rpu2oAaDGRKThXXJ1XrY1dtwOsmmxRk7aumMKIImV5lwve1MCsWi9LPdhoJvgF7dXAGqVl9j0eTgxAL2hELDlhK/7Xci3Cx04N+yaJPFMfoB7yleL2QPqxx88DnsbymNLJPtqbm1IZV7kv5ogy4+vGMOtx5MdpvxjcjlgesKMm3H6CCO+Xwe2g1Ym3UQ7Dt45YHcMpiO0yyH0CJdk49SUioiElNQ4be/F7+CMY+55ISijdmSXaU35Kyy1M46Znn4cfl7Tmiw2xQ7PfzvP4JmieqWWR4Rldc7zZWtCQaSm1BeiiTcFS/SVjgbY10uSo4gFuHm/uPrya4RLI6qC3Oj/1mWiWtPPr/pr7UMHOSMoK4ccGIpA3T5lXg/nOFziwjD/9HMDa25SMwcaPvZkf7wF9HuxcM8U8xYfkdIv01lepe6wX4tDH/9ag=
install:
- pip install awscli
- cp .env.sample .env
- sed -i 's/WEB_APP_PASSWORD=/WEB_APP_PASSWORD=travis/' .env
- sed -i 's/ADMIN_PASSWORD=/ADMIN_PASSWORD=admin/' .env
- sed -i 's/DATABASE_PASSWORD=/DATABASE_PASSWORD=district_builder/' .env
- sed -i 's/KEY_VALUE_STORE_PASSWORD=/KEY_VALUE_STORE_PASSWORD=redis/' .env
- sed -i 's/MAP_SERVER_ADMIN_PASSWORD=/MAP_SERVER_ADMIN_PASSWORD=geoserver/' .env
- "./scripts/update"
- wget -qO ./data/districtbuilder_data.zip http://s3.amazonaws.com/global-districtbuilder-data-us-east-1/pa/pa_3785_census.zip
script:
- "./scripts/test"
before_deploy:
- mkdir -p ~/.ssh
- openssl aes-256-cbc -K $encrypted_c49e2c465c08_key -iv $encrypted_c49e2c465c08_iv
  -in district-builder-pa.pem.enc -out ~/.ssh/district-builder-pa.pem -d
- cp django/publicmapping/config/config.xml deployment/user-data/config.xml
- mv ./data/districtbuilder_data.zip deployment/user-data/
deploy:
- provider: script
  skip_cleanup: true
  script: DB_SETTINGS_BUCKET=${PROD_DB_SETTINGS_BUCKET} DB_DOCKER_HOST=${PROD_DB_DOCKER_HOST} scripts/deploy
  on:
    repo: azavea/district-builder-dtl-pa
    branch: master
- provider: script
  skip_cleanup: true
  script: scripts/deploy
  on:
    repo: azavea/district-builder-dtl-pa
    branch: develop
after_deploy:
- docker-compose -f docker-compose.ci.yml run --rm --entrypoint git terraform clean -fdx
- rm -f ~/.ssh/district-builder-pa.pem
